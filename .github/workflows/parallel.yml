name: Parallel 

on:
  workflow_dispatch:
    inputs:
      file:
        description: input file
        type: choice
        default: 'julu'
        options:
          - 'julu'
          - 'julu,sibun'
          - 'julu,sibun,bagha'
      single_file:
        description: input single file
        type: string
        default: ''   
jobs:
  bagha:
    runs-on: ubuntu-latest
    steps: 
     
      - name: parallel execution
        uses: azure/CLI@v1
        with:
          azcliversion: 2.42.0
          inlineScript: |
            echo "starting mapping"
            declare -A container_dict
            container_dict["us-uat"]="fxgmsuat"
            container_dict["us-si"]="fxgmssi"
            container_dict["uat-eu"]="fxgmsuat"
            container_dict["us-perf"]="fxgmsperf"
            echo "starting"
            if [[ "${{ github.event.inputs.file }}" == "julu" || "${{ github.event.inputs.file }}" == "julu,sibun" ]]; then
              for key in "${!container_dict[@]}"; do
                if [[ "$key" =~ ^us ]]; then
                  IFS=',' read -ra FACTFILES <<< "${{ github.event.inputs.file }}"
                  for file in "${FACTFILES[@]}"; do
                    az --version
                    echo "$key $file"
                  done
                fi
              done 
            fi | xargs -n 2 -P ${#container_dict[@]} bash -c 'echo "Processing Env=$0 and File=$1"'
